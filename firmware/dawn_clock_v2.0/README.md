# Будильник рассвета v2.0

Версия 2.0 будильника рассвета на базе Wemos Mini (ESP8266) с веб-интерфейсом GyverPortal.

## Особенности

- **AC dimmer module от RobotDyn** - управление яркостью лампы через встроенный детектор нуля с фазовым управлением
- **NTP синхронизация времени** - автоматическая синхронизация через интернет
- **Веб-интерфейс GyverPortal** - удобное управление через браузер
- **mDNS поддержка** - доступ к устройству через `http://dawn-clock.local`
- **Ручное управление лампой** - ползунок яркости в веб-интерфейсе для управления в реальном времени
- **Физический переключатель** - гарантированное включение/выключение лампы через кнопку/тумблер
- **До 20 будильников** - создание и управление множественными будильниками
- **Гибкие настройки** - для каждого будильника:
  - Дни недели (выборочно)
  - Время будильника
  - Продолжительность рассвета (5-60 минут)
  - Продолжительность работы лампы после будильника
- **Плавное нарастание яркости** - имитация рассвета с линейным увеличением яркости
- **Автоматическое сохранение** - все настройки сохраняются в EEPROM

## Подключение

### AC Dimmer Module от RobotDyn

- **Z-C (Zero Crossing)** → D1 (GPIO5) на Wemos Mini
- **DIM (Dimming Control)** → D5 (GPIO14) на Wemos Mini
- **VCC** → 3.3V на Wemos Mini
- **GND** → GND на Wemos Mini

**Примечание:** Для RobotDyn модуля с встроенным детектором нуля обычно достаточно простого PWM управления на DIM пине. Модуль сам синхронизируется с нулем.

### Физический переключатель (опционально)

- **Один контакт переключателя** → D3 (GPIO0) на Wemos Mini
- **Другой контакт переключателя** → GND на Wemos Mini

**Примечание:** 
- Используется внутренняя подтяжка к VCC, поэтому при разомкнутом переключателе пин будет в состоянии HIGH
- При нажатии переключателя (замыкание на GND) лампа включается на яркость 200
- При отпускании переключателя лампа выключается
- Переключатель имеет приоритет над будильниками и веб-интерфейсом
- Можно использовать обычную кнопку или тумблер

## Настройка

1. Откройте файл `dawn_clock_v2.0.ino` в Arduino IDE
2. Установите параметры WiFi:
   ```cpp
   #define WIFI_SSID "ваш_SSID"
   #define WIFI_PASS "ваш_пароль"
   ```
3. Настройте часовой пояс:
   ```cpp
   #define GMT_OFFSET 3  // GMT+3 для Москвы
   ```
4. Загрузите прошивку на Wemos Mini

## Использование

1. После загрузки прошивки подключитесь к WiFi сети
2. Откройте браузер и перейдите по IP адресу устройства (выводится в Serial Monitor) или используйте mDNS: `http://dawn-clock.local`
3. В веб-интерфейсе вы можете:
   - Просматривать текущее время
   - Управлять лампой вручную (ползунок яркости и переключатель ручного режима)
   - Создавать новые будильники (кнопка "Добавить будильник")
   - Настраивать каждый будильник:
     - Включить/выключить
     - Установить время
     - Выбрать дни недели
     - Установить продолжительность рассвета
     - Установить продолжительность работы лампы
   - Остановить активный будильник

4. Физический переключатель (если подключен):
   - Нажатие переключателя включает лампу на максимальную яркость
   - Отпускание переключателя выключает лампу
   - Переключатель имеет приоритет над всеми другими режимами управления

## Структура данных будильника

Каждый будильник содержит:
- `enabled` - включен/выключен
- `hour` - час (0-23)
- `minute` - минута (0-59)
- `daysOfWeek` - дни недели (битовая маска: bit0=Пн, bit1=Вт, ..., bit6=Вс)
- `dawnDuration` - продолжительность рассвета в минутах (5-60)
- `lampDuration` - продолжительность работы лампы после будильника в минутах

## Логика работы

1. Система проверяет активные будильники каждую минуту
2. При наступлении времени начала рассвета (время будильника минус продолжительность рассвета) запускается плавное нарастание яркости
3. В момент времени будильника яркость достигает максимума
4. Лампа продолжает работать заданное время после будильника
5. После окончания времени работы лампа автоматически выключается

## Настройки яркости

По умолчанию:
- Минимальная яркость: 50 (из 255)
- Максимальная яркость: 200 (из 255)

Можно изменить в коде:
```cpp
#define DAWN_MIN 50
#define DAWN_MAX 200
```

## Хранение данных

Все настройки будильников сохраняются в EEPROM и автоматически загружаются при включении устройства.

## Технические детали

- **Платформа:** ESP8266 (Wemos Mini)
- **Библиотеки:**
  - GyverPortal (веб-интерфейс)
  - GyverTimer (таймеры)
  - Стандартные библиотеки ESP8266 (WiFi, time, EEPROM, mDNS)
- **Управление диммером:** Фазовое управление через прерывания на детекторе нуля (100 раз в секунду для 50Hz)
- **Приоритеты управления:**
  1. Физический переключатель (наивысший приоритет)
  2. Ручной режим через веб-интерфейс
  3. Будильники (автоматический режим)
- **mDNS имя:** `dawn-clock.local` (настраивается через `DEVICE_NAME`)

## Устранение неполадок

### Устройство не подключается к WiFi
- Проверьте правильность SSID и пароля
- Устройство автоматически создаст точку доступа "DawnClock_Setup" для настройки

### Время не синхронизируется
- Проверьте подключение к интернету
- Проверьте настройку часового пояса
- Синхронизация происходит каждый час автоматически

### Диммер не работает
- Проверьте подключение пинов (Z-C на D1, DIM на D5)
- Убедитесь, что прерывание на Z-C пине настроено правильно
- Проверьте подключение модуля RobotDyn (VCC к 3.3V, GND к GND)
- Если яркость не меняется, проверьте диапазон задержек в функции `dimmerControl()`

### Мерцание лампы
- Убедитесь, что используется фазовое управление через прерывания (не простой PWM)
- Проверьте подключение детектора нуля (Z-C пин)
- Возможно, нужно настроить диапазон задержек под вашу лампу

### mDNS (.local) не работает
- На Windows может потребоваться установка Bonjour Print Services от Apple
- На macOS и Linux .local обычно работает из коробки
- Альтернатива: используйте IP-адрес устройства

## Лицензия

См. основной README проекта.
